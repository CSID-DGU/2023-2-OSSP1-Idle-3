<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>D3.js Line Chart from JSON Data</title>
  <!-- D3.js 라이브러리 추가 -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  
  <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e35928ebe6ed7be9a8cfca7707778ffc&libraries=services"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

  <style>
    #map {
        width: 500px;
        height: 300px;
      }
    /* 그래프 스타일 */
    .line {
      fill: none;
      stroke-width: 2px;
    }
    .g{
      padding: 30px;
    }
  </style>
</head>
<body>
  <h1>JSON 데이터를 이용한 선 그래프</h1>
  <!-- SVG 요소를 담을 공간 -->
  <div>
    <svg width="510" height="300"></svg>
  </div>
  <div>
    <div id="map"></div>
    <div id="buttons"></div>
    <div>
      <label for="jsonFileName">JSON 파일명 입력: </label>
      <input type="text" id="jsonFileName"/>
      <button onclick="loadJsonData()">데이터 로드</button>
      <label id="nowIndex"></label>
    </div>
  </div>
  <div>
    <label id="data"></label>
  </div>
  

  <script>
    var map;
    var infoWindow;
    var markers = [];
    const fileName = "test_4_1_10.json"
    function makeGraph(fileName){
      // JSON 파일에서 데이터 가져오기
      
      d3.json(fileName).then(function(data) {
        let result = data.result;
        // SVG 요소 선택
        const svg = d3.select("svg");

        // x축 스케일 설정
        const xScale = d3.scaleLinear()
          .domain([0, result.length - 1])
          .range([0, 500]);

        // y축 스케일 설정
        const yScale = d3.scaleLinear()
          .domain([0, 3000])
          .range([100, 0]);

        // x축 생성
        svg.append("g")
          .attr("transform", "translate(40, 100)")
          .call(d3.axisBottom(xScale));

        // y축 생성
        svg.append("g")
          .attr("transform", "translate(40, 0)")
          .call(d3.axisLeft(yScale));


        // 선 생성
        console.log(result[0])
        const line_sum = d3.line()
          .x(result => xScale(result.index))
          .y(result => yScale(result.answer.sum));

        const line_gap = d3.line()
          .x(result => xScale(result.index))
          .y(result => yScale(result.answer.gap));

        // const line_alpha = d3.line()
        // .x(d => xScale(d.index))
        // .y(d => yScale(d.alpha));

        // 선 그래프 그리기
        svg.append("path")
          .datum(result)
          .attr("class", "line")
          .attr("transform", "translate(40, 0)")
          .attr("d", line_sum)
          .attr("stroke", "green");

        svg.append("path")
          .datum(result)
          .attr("class", "line")
          .attr("transform", "translate(40, 0)")
          .attr("d", line_gap)
          .attr("stroke", "steelblue");

        // svg.append("path")
        //   .datum(result)
        //   .attr("class", "line")
        //   .attr("transform", "translate(40, 0)")
        //   .attr("d", line_alpha)
        //   .attr("stroke", "red");

      }).catch(function(error) {
        // 에러 처리
        console.error("데이터를 불러오는 중 에러 발생:", error);
      });
    }
    
    function initMap() {
      var mapContainer = document.getElementById("map");
      var mapOption = {
        center: new kakao.maps.LatLng(37.566826, 126.9786567),
        level: 3,
      };

      map = new kakao.maps.Map(mapContainer, mapOption);
      infoWindow = new kakao.maps.InfoWindow({
        zIndex: 1,
        removable: true,
      });
    }

    function loadJsonData(fileName) {
      var userInput = document.getElementById("jsonFileName").value;
      fileName = userInput.trim() || fileName;
      
      makeGraph(fileName);
      fetch(fileName)
        .then((response) => response.json())
        .then((jsonData) => {
          addButtons(jsonData.result);
        })
        .catch((error) => {
          console.error("에러 발생:", error);
        });
    }

    function addButtons(results) {
      var buttonsContainer = document.getElementById("buttons");

      buttonsContainer.innerHTML = "";

      results.forEach((result) => {
        var button = document.createElement("button");
        var index = result.index;
        button.textContent = "Index " + result.index;
        button.addEventListener("click", function () {
          var nowIndex = document.getElementById("nowIndex");
          var dataLabel = document.getElementById("data");
          nowIndex.textContent = button.textContent;
          dataLabel.textContent = result.inputPoints[index];
          addMarkers(result.inputPoints);
          addCustomMarker(
            result.answer.position.latitude,
            result.answer.position.longitude,
            "https://cdn-icons-png.flaticon.com/512/6388/6388034.png"
          );
        });
        buttonsContainer.appendChild(button);
      });
    }

    function addMarkers(inputPoints) {
      markers.forEach(function (marker) {
        marker.setMap(null);
      });
      markers = [];

      inputPoints.forEach((point) => {
        addMarker(point.latitude, point.longitude);
      });
    }

    function addMarker(latitude, longitude) {
      var marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(latitude, longitude),
        map: map,
      });
      markers.push(marker);
    }

    function addCustomMarker(latitude, longitude, imageUrl) {
      var markerImage = new kakao.maps.MarkerImage(
        imageUrl,
        new kakao.maps.Size(50, 50),
        { offset: new kakao.maps.Point(25, 50) }
      );

      var marker = new kakao.maps.Marker({
        position: new kakao.maps.LatLng(latitude, longitude),
        map: map,
        clickable: true,
        image: markerImage,
      });

      kakao.maps.event.addListener(marker, "click", function () {
        showInfoWindow(latitude, longitude);
      });

      markers.push(marker);
    }

    function showInfoWindow(latitude, longitude) {
      var content =
        '<div style="font-size: 12px; padding: 20px;">' +
        "위도 : " +
        latitude +
        "<br>경도 : " +
        longitude;

      infoWindow.setContent(content);
      infoWindow.setPosition(new kakao.maps.LatLng(latitude, longitude));
      infoWindow.open(map);
    }

    kakao.maps.load(function () {
      initMap();
    });


    

  </script>
</body>
</html>